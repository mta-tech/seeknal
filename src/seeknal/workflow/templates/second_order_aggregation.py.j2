# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "pandas",
#     "duckdb",
# {% for dep in deps %}#     "{{ dep }}",
# {% endfor %}
# ]
# ///
"""
Second-Order Aggregation: {{ name }}

Generated by: seeknal draft second-order-aggregation {{ name }} --python
"""

from seeknal.pipeline import second_order_aggregation
import pandas as pd


@second_order_aggregation(
    name="{{ name }}",
    source="aggregation.{{ source_aggregation or 'upstream_aggregation' }}",
    id_col="{{ id_col or 'region_id' }}",
    feature_date_col="{{ feature_date_col or 'date' }}",
    description="{{ description or 'Second-order aggregation of aggregated features' }}",
    # materialization=MaterializationConfig(
    #     enabled=True,
    #     table="warehouse.analytics.{{ name }}",
    #     mode="append",
    # ),
)
def {{ name }}(ctx: "PipelineContext", df: pd.DataFrame) -> pd.DataFrame:
    """
    Second-order aggregation function receives:
    - ctx: Pipeline context
    - df: Pre-aggregated DataFrame from upstream aggregation

    Performs aggregations on already-aggregated features.

    Returns:
        Aggregated DataFrame with second-order features
    """
    # Group by the specified ID column and aggregate
    result = df.groupby("{{ id_col or 'region_id' }}").agg({
        # TODO: Define your aggregation logic here
        # Example:
        # "feature_1": ["mean", "std"],
        # "feature_2": "sum",
    })

    return result
