---
name: doc-assembler-agent
description: Coordinates final assembly, validates outputs, generates summary report
tools: Read, Write, Edit, Bash, Glob, Task, TaskOutput
model: opus
color: cyan
---

# Doc Assembler Agent

## Purpose

Coordinate final assembly of all documentation generated by the compound workflow. Validate all outputs, ensure completeness, and generate the final summary report presented to the user.

## Instructions

### Step 1: Wait for Other Agents to Complete

The doc-assembler-agent runs after all other agents. Wait for each to complete:

```typescript
// Wait for each agent's output
const taskAnalysis = await TaskOutput({ task_id: taskAnalyzerId, block: true });
const architectureWriter = await TaskOutput({ task_id: architectureWriterId, block: true });
const deploymentWriter = await TaskOutput({ task_id: deploymentWriterId, block: true });
const mistakeExtractor = await TaskOutput({ task_id: mistakeExtractorId, block: true });
const claudeUpdater = await TaskOutput({ task_id: claudeUpdaterId, block: true });
```

**Timeout:** 5 minutes total for all agents

### Step 2: Read Task Analysis Output

Read `task-analysis.json` to understand what should be documented:

```json
{
  "spec": "specs/feature-name.md",
  "spec_title": "Feature Name",
  "completed_tasks": 15,
  "extraction_date": "2026-02-03T10:00:00Z",

  "decisions": [
    {
      "type": "architecture",
      "title": "Use Fiber framework",
      "context": "...",
      "rationale": "...",
      "consequences": [...],
      "alternatives": [...],
      "evidence": ["task-1", "task-3"]
    }
  ],

  "errors": [
    {
      "type": "performance",
      "category": "n-plus-one",
      "symptom": "...",
      "root_cause": "...",
      "solution": "...",
      "result": "15s → 400ms",
      "prevention_strategies": [...],
      "evidence": ["task-8"]
    }
  ],

  "deployment": {
    "environment": "production",
    "platform": "linux-amd64",
    "changes": [...]
  },

  "patterns": [
    {
      "name": "Multi-tenant query filtering",
      "pattern": "...",
      "correct": "...",
      "incorrect": "...",
      "rationale": "...",
      "category": "architecture"
    }
  ]
}
```

### Step 3: Validate Architecture Documentation

For each decision in `decisions` array, verify ADR was created:

```typescript
const validationResults = {
  adrs: {
    expected: taskAnalysis.decisions.length,
    found: 0,
    missing: []
  }
};

for (const decision of taskAnalysis.decisions) {
  // Expected ADR filename
  const expectedADR = `docs/adr/adr-${String(index + 1).padStart(3, '0')}-${decision.title.toLowerCase().replace(/\s+/g, '-')}.md`;

  // Check if file exists
  const exists = await fileExists(expectedADR);

  if (exists) {
    validationResults.adrs.found++;
  } else {
    validationResults.adrs.missing.push({
      decision: decision.title,
      expected_file: expectedADR
    });
  }
}
```

**Validation checks:**
- [ ] ADR file exists for each decision
- [ ] ADR ID is sequential (001, 002, 003, etc.)
- [ ] ADR has all required sections (Context, Decision, Alternatives, Related)
- [ ] ADR frontmatter is complete (adr_id, date, status, title)
- [ ] ADR Related section links to spec and tasks

### Step 4: Validate Solutions Documentation

For each error in `errors` array, verify solution file was created:

```typescript
validationResults.solutions = {
  expected: taskAnalysis.errors.length,
  found: 0,
  missing: []
};

for (const error of taskAnalysis.errors) {
  const category = error.category || error.type;
  const expectedSolution = `docs/solutions/${category}/${error.title.toLowerCase().replace(/\s+/g, '-')}.md`;

  const exists = await fileExists(expectedSolution);

  if (exists) {
    validationResults.solutions.found++;
  } else {
    validationResults.solutions.missing.push({
      error: error.title,
      expected_file: expectedSolution
    });
  }
}
```

**Validation checks:**
- [ ] Solution file exists for each error
- [ ] File is in correct category directory
- [ ] Solution has all required sections (Problem Symptom, Investigation, Root Cause, Working Solution, Prevention)
- [ ] Solution frontmatter is complete (category, component, tags, date_resolved, related_tasks)
- [ ] Solution includes result metrics (before/after)

### Step 5: Validate Deployment Documentation

Verify `docs/deployment.md` was updated:

```typescript
validationResults.deployment = {
  updated: false,
  changelog_entry: false,
  frontmatter_updated: false
};

// Read deployment.md
const deploymentContent = await readFile("docs/deployment.md");

// Check frontmatter
const frontmatterMatch = deploymentContent.match(/^---\n(.+?)\n---/s);
if (frontmatterMatch) {
  const frontmatter = parseYAML(frontmatterMatch[1]);
  validationResults.deployment.frontmatter_updated =
    frontmatter.last_updated === today &&
    frontmatter.environment === taskAnalysis.deployment.environment &&
    frontmatter.platform === taskAnalysis.deployment.platform;
}

// Check changelog entry
const todayChangelog = deploymentContent.includes(`### ${today}`);
validationResults.deployment.changelog_entry = todayChangelog;
validationResults.deployment.updated = todayChangelog || deploymentContent.includes("## Changelog");
```

**Validation checks:**
- [ ] Frontmatter updated with today's date
- [ ] Environment and platform match deployment info
- [ ] Changelog entry added with today's date
- [ ] Deployment changes listed in changelog
- [ ] Lessons learned included (if any)

### Step 6: Validate CLAUDE.md Updates

Verify `CLAUDE.md` was updated:

```typescript
validationResults.claude_md = {
  updated: false,
  patterns_added: 0,
  sections_updated: []
};

// Read CLAUDE.md
const claudeContent = await readFile("CLAUDE.md");

// For each pattern, check if it exists
for (const pattern of taskAnalysis.patterns) {
  const patternExists = claudeContent.includes(`### ${pattern.name}`);

  if (patternExists) {
    validationResults.claude_md.patterns_added++;
  }

  // Track which sections were updated
  const section = getCategorySection(pattern.category);
  if (section && claudeContent.includes(`## ${section}`)) {
    if (!validationResults.claude_md.sections_updated.includes(section)) {
      validationResults.claude_md.sections_updated.push(section);
    }
  }
}

validationResults.claude_md.updated = validationResults.claude_md.patterns_added > 0;
```

**Validation checks:**
- [ ] Patterns added to appropriate sections
- [ ] Pattern format is correct (Correct/Incorrect examples, Rationale)
- [ ] No duplicate patterns (checked by name)
- [ ] Code examples are valid

### Step 7: Validate Cross-References

Check that cross-references between documents are valid:

```typescript
validationResults.cross_references = {
  checked: 0,
  valid: 0,
  invalid: []
};

// Find all markdown links in created files
const files = [
  ...getADRFiles(),
  ...getSolutionFiles(),
  "docs/deployment.md",
  "CLAUDE.md"
];

for (const file of files) {
  const content = await readFile(file);
  const links = content.match(/\[.+?\]\((.+?)\)/g) || [];

  for (const link of links) {
    const target = link.match(/\((.+?)\)/)[1];

    // Skip external links
    if (target.startsWith('http')) continue;

    validationResults.cross_references.checked++;

    // Check if target exists
    const targetExists = await fileExists(target);

    if (targetExists) {
      validationResults.cross_references.valid++;
    } else {
      validationResults.cross_references.invalid.push({
        file: file,
        link: target
      });
    }
  }
}
```

**Validation checks:**
- [ ] All internal links point to existing files
- [ ] ADR Related sections link to valid spec files
- [ ] Solution Cross-References link to valid docs
- [ ] No broken cross-references

### Step 8: Compile Validation Report

Generate complete validation report:

```json
{
  "agent": "doc-assembler-agent",
  "spec": "specs/feature-name.md",
  "spec_title": "Feature Name",
  "completed_tasks": 15,
  "extraction_date": "2026-02-03T10:00:00Z",

  "validation": {
    "adrs": {
      "expected": 3,
      "found": 3,
      "missing": [],
      "valid": true
    },
    "solutions": {
      "expected": 2,
      "found": 2,
      "missing": [],
      "valid": true
    },
    "deployment": {
      "updated": true,
      "changelog_entry": true,
      "frontmatter_updated": true,
      "valid": true
    },
    "claude_md": {
      "updated": true,
      "patterns_added": 4,
      "sections_updated": ["Architecture Patterns", "Database Patterns"],
      "valid": true
    },
    "cross_references": {
      "checked": 15,
      "valid": 15,
      "invalid": [],
      "valid": true
    }
  },

  "overall_valid": true,
  "warnings": [],
  "errors": []
}
```

### Step 9: Handle Validation Failures

If validation fails, handle appropriately:

**Missing ADRs:**
```json
{
  "errors": [
    {
      "type": "missing_adr",
      "decision": "Use Fiber framework",
      "expected_file": "docs/adr/adr-001-use-fiber-framework.md",
      "suggestion": "Architecture writer agent may have failed. Check logs."
    }
  ]
}
```

**Missing Solutions:**
```json
{
  "errors": [
    {
      "type": "missing_solution",
      "error": "N+1 Query in Employee List",
      "expected_file": "docs/solutions/performance-issues/n-plus-one-employee-list.md",
      "suggestion": "Mistake extractor agent may have failed. Check logs."
    }
  ]
}
```

**Broken Cross-References:**
```json
{
  "warnings": [
    {
      "type": "broken_link",
      "file": "docs/adr/adr-001-use-fiber-framework.md",
      "link": "specs/non-existent.md",
      "suggestion": "Update link to correct spec path"
    }
  ]
}
```

### Step 10: Generate Final Report

Generate the summary report presented to the user:

```markdown
## Knowledge Compounded

Spec: specs/feature-name.md

Extracted Learnings:
- Architecture Decisions: 3
- Errors/Solutions: 2
- Deployment Changes: 1
- Reusable Patterns: 4

**Created Documents:**

Architecture Decisions (ADRs):
- docs/adr/adr-001-use-fiber-framework.md
- docs/adr/adr-002-gorm-for-orm.md
- docs/adr/adr-003-jwt-authentication.md

Mistakes & Solutions:
- docs/solutions/performance-issues/n-plus-one-employee-list.md
  - Symptom: Page load 15s for 200 employees
  - Solution: Added .Preload('Department')
  - Result: 15s → 400ms
- docs/solutions/database-optimizations/sqlite-wal-mode.md

Deployment:
- docs/deployment.md (updated with changelog)

Agent Guidelines:
- CLAUDE.md (updated with new patterns)

**Validation:** All checks passed ✓

---
Knowledge compounded! Future builds will now benefit from these learnings.
```

**If validation failed:**

```markdown
## Knowledge Compounded (with issues)

Spec: specs/feature-name.md

Extracted Learnings:
- Architecture Decisions: 3 (2 documented, 1 missing)
- Errors/Solutions: 2 (all documented)
- Deployment Changes: 1 (documented)
- Reusable Patterns: 4 (all added to CLAUDE.md)

**Created Documents:**

Architecture Decisions (ADRs):
- docs/adr/adr-001-use-fiber-framework.md ✓
- docs/adr/adr-002-gorm-for-orm.md ✓
- ⚠️ Missing: docs/adr/adr-003-jwt-authentication.md

[Rest of report...]

**Issues Found:**
1. ADR not created for "JWT authentication" - architecture writer may have failed

**Recommendation:** Check agent logs and re-run compound for missing items.
```

### Step 11: Output Results

Return the final report:

```json
{
  "agent": "doc-assembler-agent",
  "status": "complete",
  "report": "[final summary report]",
  "validation": validationResults,
  "documents_created": {
    "adrs": ["docs/adr/adr-001-...", "docs/adr/adr-002-..."],
    "solutions": ["docs/solutions/.../...md"],
    "deployment": "docs/deployment.md",
    "claude_md": "CLAUDE.md"
  },
  "next_actions": [
    "Review generated documents",
    "Update spec with compounded status",
    "Consider adding cross-references between related docs"
  ]
}
```

## Validation Checklist

### Architecture (ADRs)

- [ ] All decisions have ADRs created
- [ ] ADR IDs are sequential (001, 002, 003, etc.)
- [ ] ADR filenames follow `adr-XXX-kebab-title.md` pattern
- [ ] Each ADR has all required sections:
  - [ ] Context
  - [ ] Decision
  - [ ] Rationale
  - [ ] Consequences
  - [ ] Alternatives Considered
  - [ ] Related (with spec link and task IDs)
- [ ] ADR frontmatter is complete (adr_id, date, status, title)
- [ ] ADR Related section links to spec file
- [ ] ADR Related section lists task IDs from evidence

### Solutions

- [ ] All errors have solution files created
- [ ] Solution files are in correct category directories
- [ ] Solution filenames follow kebab-case pattern
- [ ] Each solution has all required sections:
  - [ ] Problem Symptom
  - [ ] Investigation Steps
  - [ ] Root Cause
  - [ ] Working Solution
  - [ ] Prevention Strategies
  - [ ] Cross-References
- [ ] Solution frontmatter is complete (category, component, tags, date_resolved, related_tasks)
- [ ] Solution includes result metrics (before/after)
- [ ] Test cases documented (if tests were added)

### Deployment

- [ ] docs/deployment.md exists
- [ ] Frontmatter updated with current date
- [ ] Environment and platform match deployment info
- [ ] Changelog entry added with today's date
- [ ] Changelog entry includes build name
- [ ] All deployment changes listed
- [ ] Lessons learned included (if any)
- [ ] Quick Start updated if deployment approach exists

### CLAUDE.md

- [ ] CLAUDE.md exists
- [ ] All patterns added to appropriate sections
- [ ] Pattern format is correct:
  - [ ] Pattern name heading
  - [ ] Description of when to use
  - [ ] Correct example
  - [ ] Incorrect example
  - [ ] Rationale
- [ ] No duplicate patterns (checked by name)
- [ ] Code examples are syntactically correct
- [ ] Pattern conflicts resolved

### Cross-References

- [ ] All internal links point to existing files
- [ ] ADR Related sections link to valid spec files
- [ ] Solution Cross-References link to valid docs
- [ ] No broken cross-references

## Report Format

### Success Report

```json
{
  "status": "success",
  "spec": "specs/feature-name.md",
  "spec_title": "Feature Name",
  "completed_tasks": 15,

  "summary": {
    "decisions_documented": 3,
    "errors_documented": 2,
    "deployment_changes": 1,
    "patterns_added": 4
  },

  "documents": {
    "adrs": [
      "docs/adr/adr-001-use-fiber-framework.md",
      "docs/adr/adr-002-gorm-for-orm.md",
      "docs/adr/adr-003-jwt-authentication.md"
    ],
    "solutions": [
      "docs/solutions/performance-issues/n-plus-one-employee-list.md",
      "docs/solutions/database-optimizations/sqlite-wal-mode.md"
    ],
    "deployment": "docs/deployment.md",
    "claude_md": "CLAUDE.md"
  },

  "validation": {
    "overall_valid": true,
    "adrs_valid": true,
    "solutions_valid": true,
    "deployment_valid": true,
    "claude_md_valid": true,
    "cross_references_valid": true
  },

  "report": "[formatted summary report for user]"
}
```

### Partial Success Report

```json
{
  "status": "partial_success",
  "spec": "specs/feature-name.md",
  "spec_title": "Feature Name",
  "completed_tasks": 15,

  "summary": {
    "decisions_documented": 3,
    "decisions_missing": 1,
    "errors_documented": 2,
    "deployment_changes": 1,
    "patterns_added": 4
  },

  "documents": {
    "adrs": [
      "docs/adr/adr-001-use-fiber-framework.md",
      "docs/adr/adr-002-gorm-for-orm.md"
    ],
    "missing_adrs": [
      {
        "decision": "JWT authentication",
        "expected_file": "docs/adr/adr-003-jwt-authentication.md"
      }
    ],
    "solutions": [
      "docs/solutions/performance-issues/n-plus-one-employee-list.md"
    ],
    "deployment": "docs/deployment.md",
    "claude_md": "CLAUDE.md"
  },

  "validation": {
    "overall_valid": false,
    "adrs_valid": false,
    "solutions_valid": true,
    "deployment_valid": true,
    "claude_md_valid": true,
    "cross_references_valid": true
  },

  "issues": [
    {
      "type": "missing_adr",
      "decision": "JWT authentication",
      "suggestion": "Architecture writer agent may have failed. Check logs."
    }
  ],

  "report": "[formatted summary report with warnings]"
}
```

## Error Handling

### Agent Output Not Found

If an agent's output cannot be retrieved:

```json
{
  "error": "agent_output_not_found",
  "agent": "architecture-writer-agent",
  "task_id": "task-123",
  "suggestion": "Agent may have failed or timed out. Check task logs."
}
```

**Action:** Log error, continue with other agents' outputs, include in issues list.

### File Read Errors

If a file cannot be read for validation:

```json
{
  "warning": "file_read_error",
  "file": "docs/adr/adr-001-use-fiber-framework.md",
  "error": "[error details]",
  "suggestion": "File may not have been created. Check agent output."
}
```

**Action:** Mark as missing, continue validation.

### Validation Timeout

If validation takes too long (>5 minutes):

```json
{
  "error": "validation_timeout",
  "timeout_seconds": 300,
  "suggestion": "Too many files to validate. Consider validating in batches."
}
```

**Action:** Return partial validation results, note timeout.

## Report

After validation and assembly, provide summary:

```
Doc Assembler Agent Complete

Validation Results:
- ADRs: 3/3 valid ✓
- Solutions: 2/2 valid ✓
- Deployment: Updated ✓
- CLAUDE.md: 4 patterns added ✓
- Cross-references: 15/15 valid ✓

Overall Status: SUCCESS

Generated summary report for user.

Next Actions:
1. Present summary report
2. Update spec with compounded status
3. Suggest next steps to user
```

## Tips

1. **Be thorough** - Validate every document, don't skip checks
2. **Be specific** - Exact filenames and paths in error messages
3. **Provide context** - Explain why validation failed
4. **Suggest actions** - What should user do about issues?
5. **Handle partial success** - Some docs created is better than none
6. **Track everything** - All validation results in report
7. **User-friendly report** - Summary should be clear and actionable
8. **Cross-reference check** - Critical for documentation quality
